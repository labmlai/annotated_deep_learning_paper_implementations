{
 "<h1>Prioritized Experience Replay Buffer</h1>\n<p>This implements paper <a href=\"https://arxiv.org/abs/1511.05952\">Prioritized experience replay</a>, using a binary segment tree.</p>\n<p><a href=\"https://colab.research.google.com/github/labmlai/annotated_deep_learning_paper_implementations/blob/master/labml_nn/rl/dqn/experiment.ipynb\"><span translate=no>_^_0_^_</span></a></p>\n": "<h1>\u4f18\u5148\u4f53\u9a8c\u91cd\u64ad\u7f13\u51b2\u533a</h1>\n<p>\u8fd9\u4f7f\u7528\u4e8c\u53c9\u5206\u6bb5\u6811\u5b9e\u73b0\u4e86\u7eb8\u8d28<a href=\"https://arxiv.org/abs/1511.05952\">\u4f18\u5148\u4f53\u9a8c\u56de\u653e</a>\u3002</p>\n<p><a href=\"https://colab.research.google.com/github/labmlai/annotated_deep_learning_paper_implementations/blob/master/labml_nn/rl/dqn/experiment.ipynb\"><span translate=no>_^_0_^_</span></a></p>\n",
 "<h2>Buffer for Prioritized Experience Replay</h2>\n<p><a href=\"https://arxiv.org/abs/1511.05952\">Prioritized experience replay</a>  samples important transitions more frequently. The transitions are prioritized by the Temporal Difference error (td error), <span translate=no>_^_0_^_</span>.</p>\n<p>We sample transition <span translate=no>_^_1_^_</span> with probability, <span translate=no>_^_2_^_</span> where <span translate=no>_^_3_^_</span> is a hyper-parameter that determines how much prioritization is used, with <span translate=no>_^_4_^_</span> corresponding to uniform case. <span translate=no>_^_5_^_</span> is the priority.</p>\n<p>We use proportional prioritization <span translate=no>_^_6_^_</span> where <span translate=no>_^_7_^_</span> is the temporal difference for transition <span translate=no>_^_8_^_</span>.</p>\n<p>We correct the bias introduced by prioritized replay using  importance-sampling (IS) weights <span translate=no>_^_9_^_</span> in the loss function. This fully compensates when <span translate=no>_^_10_^_</span>. We normalize weights by <span translate=no>_^_11_^_</span> for stability. Unbiased nature is most important towards the convergence at end of training. Therefore we increase <span translate=no>_^_12_^_</span> towards end of training.</p>\n<h3>Binary Segment Tree</h3>\n<p>We use a binary segment tree to efficiently calculate <span translate=no>_^_13_^_</span>, the cumulative probability, which is needed to sample. We also use a binary segment tree to find <span translate=no>_^_14_^_</span>, which is needed for <span translate=no>_^_15_^_</span>. We can also use a min-heap for this. Binary Segment Tree lets us calculate these in <span translate=no>_^_16_^_</span> time, which is way more efficient that the naive <span translate=no>_^_17_^_</span> approach.</p>\n<p>This is how a binary segment tree works for sum; it is similar for minimum. Let <span translate=no>_^_18_^_</span> be the list of <span translate=no>_^_19_^_</span> values we want to represent. Let <span translate=no>_^_20_^_</span> be the <span translate=no>_^_21_^_</span> node of the <span translate=no>_^_22_^_</span> row  in the binary tree. That is two children of node <span translate=no>_^_23_^_</span> are <span translate=no>_^_24_^_</span> and <span translate=no>_^_25_^_</span>.</p>\n<p>The leaf nodes on row <span translate=no>_^_26_^_</span>  will have values of <span translate=no>_^_27_^_</span>. Every node keeps the sum of the two child nodes. That is, the root node keeps the sum of the entire array of values. The left and right children of the root node keep  the sum of the first half of the array and  the sum of the second half of the array, respectively. And so on...</p>\n<p><span translate=no>_^_28_^_</span></p>\n<p>Number of nodes in row <span translate=no>_^_29_^_</span>, <span translate=no>_^_30_^_</span> This is equal to the sum of nodes in all rows above <span translate=no>_^_31_^_</span>. So we can use a single array <span translate=no>_^_32_^_</span> to store the tree, where, <span translate=no>_^_33_^_</span></p>\n<p>Then child nodes of <span translate=no>_^_34_^_</span> are <span translate=no>_^_35_^_</span> and <span translate=no>_^_36_^_</span>. That is, <span translate=no>_^_37_^_</span></p>\n<p>This way of maintaining binary trees is very easy to program. <em>Note that we are indexing starting from 1</em>.</p>\n<p>We use the same structure to compute the minimum.</p>\n": "<h2>\u4f18\u5148\u4f53\u9a8c\u56de\u653e\u7684\u7f13\u51b2\u533a</h2>\n<p><a href=\"https://arxiv.org/abs/1511.05952\">\u4f18\u5148\u4f53\u9a8c\u91cd\u64ad</a>\u4f1a\u66f4\u9891\u7e41\u5730\u91c7\u6837\u91cd\u8981\u7684\u8fc7\u6e21\u3002\u8fc7\u6e21\u7684\u4f18\u5148\u7ea7\u7531\u65f6\u5dee\u8bef\u5dee\uff08td \u9519\u8bef\uff09\u786e\u5b9a<span translate=no>_^_0_^_</span>\u3002</p>\n<p>\u6211\u4eec<span translate=no>_^_1_^_</span>\u4f7f\u7528\u6982\u7387\u5bf9\u8fc7\u6e21\u8fdb\u884c\u62bd\u6837\uff0c<span translate=no>_^_2_^_</span>\u5176\u4e2d<span translate=no>_^_3_^_</span>\u662f\u786e\u5b9a\u4f7f\u7528\u591a\u5c11\u4f18\u5148\u7ea7\u7684\u8d85\u53c2\u6570\uff0c<span translate=no>_^_4_^_</span>\u5bf9\u5e94\u4e8e\u7edf\u4e00\u5927\u5c0f\u5199\u3002<span translate=no>_^_5_^_</span>\u662f\u5f53\u52a1\u4e4b\u6025\u3002</p>\n<p>\u6211\u4eec\u4f7f\u7528\u6bd4\u4f8b\u4f18\u5148\u7ea7<span translate=no>_^_7_^_</span>\uff0c<span translate=no>_^_6_^_</span>\u5176\u4e2d\u662f\u8fc7\u6e21\u7684\u65f6\u95f4\u5dee\u5f02<span translate=no>_^_8_^_</span>\u3002</p>\n<p>\u6211\u4eec\u4f7f\u7528\u635f\u5931\u51fd\u6570\u4e2d\u7684\u91cd\u8981\u6027\u91c7\u6837\uff08IS\uff09\u6743\u91cd\u6765\u7ea0\u6b63\u4f18\u5148\u91cd\u64ad\u5f15<span translate=no>_^_9_^_</span>\u5165\u7684\u504f\u5dee\u3002\u8fd9\u5b8c\u5168\u8865\u507f\u4e86<span translate=no>_^_10_^_</span>.\u4e3a\u4e86\u7a33\u5b9a\u8d77\u89c1\uff0c\u6211\u4eec\u5c06\u6743\u91cd\u5f52<span translate=no>_^_11_^_</span>\u4e00\u5316\u3002\u5bf9\u4e8e\u8bad\u7ec3\u7ed3\u675f\u65f6\u7684\u8d8b\u540c\uff0c\u516c\u6b63\u7684\u672c\u8d28\u6700\u4e3a\u91cd\u8981\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u5728\u8bad\u7ec3\u5feb\u8981<span translate=no>_^_12_^_</span>\u7ed3\u675f\u65f6\u589e\u52a0\u4e86\u3002</p>\n<h3>\u4e8c\u53c9\u6bb5\u6811</h3>\n<p>\u6211\u4eec\u4f7f\u7528\u4e8c\u53c9\u6bb5\u6811\u6765\u6709\u6548\u5730\u8ba1\u7b97<span translate=no>_^_13_^_</span>\u91c7\u6837\u6240\u9700\u7684\u7d2f\u79ef\u6982\u7387\u3002\u6211\u4eec\u8fd8\u4f7f\u7528\u4e8c\u53c9\u6bb5\u6811\u6765\u67e5\u627e<span translate=no>_^_14_^_</span>\uff0c\u8fd9\u662f\u5fc5\u9700\u7684<span translate=no>_^_15_^_</span>\u3002\u6211\u4eec\u4e5f\u53ef\u4ee5\u4e3a\u6b64\u4f7f\u7528\u6700\u5c0f\u5806\u3002\u4e8c\u53c9\u6bb5\u6811\u53ef\u4ee5\u8ba9\u6211\u4eec<span translate=no>_^_16_^_</span>\u53ca\u65f6\u8ba1\u7b97\u5b83\u4eec\uff0c\u8fd9\u6bd4\u5929\u771f<span translate=no>_^_17_^_</span>\u7684\u65b9\u6cd5\u6548\u7387\u8981\u9ad8\u5f97\u591a\u3002</p>\n<p>\u8fd9\u5c31\u662f\u4e8c\u53c9\u6bb5\u6811\u6c42\u548c\u7684\u65b9\u5f0f\uff1b\u5b83\u4e0e\u6700\u5c0f\u503c\u76f8\u4f3c\u3002\u8ba9\u6211\u4eec<span translate=no>_^_18_^_</span>\u6765\u770b\u6211\u4eec\u8981\u8868\u793a\u7684<span translate=no>_^_19_^_</span>\u503c\u7684\u5217\u8868\u3002\u8ba9\u6211\u4eec<span translate=no>_^_20_^_</span>\u6210\u4e3a\u4e8c\u53c9\u6811\u4e2d<span translate=no>_^_22_^_</span>\u884c\u7684<span translate=no>_^_21_^_</span>\u8282\u70b9\u3002\u8fd9\u662f\u8282\u70b9\u7684\u4e24\u4e2a\u5b50\u8282\u70b9<span translate=no>_^_23_^_</span>\u662f<span translate=no>_^_24_^_</span>\u548c<span translate=no>_^_25_^_</span>\u3002</p>\n<p>\u884c\u4e0a\u7684\u53f6\u8282\u70b9\u7684\u503c<span translate=no>_^_26_^_</span>\u5c06\u4e3a<span translate=no>_^_27_^_</span>\u3002\u6bcf\u4e2a\u8282\u70b9\u90fd\u4fdd\u7559\u4e24\u4e2a\u5b50\u8282\u70b9\u7684\u603b\u548c\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u6839\u8282\u70b9\u4fdd\u7559\u6574\u4e2a\u6570\u7ec4\u503c\u7684\u603b\u548c\u3002\u6839\u8282\u70b9\u7684\u5de6\u4fa7\u548c\u53f3\u4fa7\u5b50\u8282\u70b9\u5206\u522b\u4fdd\u7559\u6570\u7ec4\u524d\u534a\u90e8\u5206\u548c\u540e\u534a\u90e8\u5206\u7684\u603b\u548c\u3002\u4f9d\u6b64\u7c7b\u63a8...</p>\n<p><span translate=no>_^_28_^_</span></p>\n<p>\u884c\u4e2d\u7684\u8282\u70b9\u6570<span translate=no>_^_29_^_</span>\uff0c<span translate=no>_^_30_^_</span>\u8fd9\u7b49\u4e8e\u4ee5\u4e0a\u6240\u6709\u884c\u4e2d\u7684\u8282\u70b9\u603b\u548c<span translate=no>_^_31_^_</span>\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5355\u4e2a\u6570\u7ec4<span translate=no>_^_32_^_</span>\u6765\u5b58\u50a8\u6811\uff0c\u5176\u4e2d\uff0c<span translate=no>_^_33_^_</span></p>\n<p>\u7136\u540e<span translate=no>_^_34_^_</span>\u662f<span translate=no>_^_35_^_</span>\u548c\u7684\u5b50\u8282\u70b9<span translate=no>_^_36_^_</span>\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c<span translate=no>_^_37_^_</span></p>\n<p>\u8fd9\u79cd\u7ef4\u62a4\u4e8c\u53c9\u6811\u7684\u65b9\u6cd5\u5f88\u5bb9\u6613\u7f16\u7a0b\u3002<em>\u8bf7\u6ce8\u610f\uff0c\u6211\u4eec\u4ece 1 \u5f00\u59cb\u7d22\u5f15</em>\u3002</p>\n<p>\u6211\u4eec\u4f7f\u7528\u76f8\u540c\u7684\u7ed3\u6784\u6765\u8ba1\u7b97\u6700\u5c0f\u503c\u3002</p>\n",
 "<h3>Add sample to queue</h3>\n": "<h3>\u5c06\u6837\u54c1\u6dfb\u52a0\u5230\u961f\u5217</h3>\n",
 "<h3>Initialize</h3>\n": "<h3>\u521d\u59cb\u5316</h3>\n",
 "<h3>Sample from buffer</h3>\n": "<h3>\u6765\u81ea\u7f13\u51b2\u6db2\u7684\u6837\u672c</h3>\n",
 "<h3>Update priorities</h3>\n": "<h3>\u66f4\u65b0\u4f18\u5148\u7ea7</h3>\n",
 "<h3>Whether the buffer is full</h3>\n": "<h3>\u7f13\u51b2\u533a\u662f\u5426\u5df2\u6ee1</h3>\n",
 "<h4><span translate=no>_^_0_^_</span></h4>\n": "<h4><span translate=no>_^_0_^_</span></h4>\n",
 "<h4>Find largest <span translate=no>_^_0_^_</span> such that <span translate=no>_^_1_^_</span></h4>\n": "<h4>\u627e\u5230<span translate=no>_^_0_^_</span>\u8fd9\u6837\u7684\u6700\u5927<span translate=no>_^_1_^_</span></h4>\n",
 "<h4>Set priority in binary segment tree for minimum</h4>\n": "<h4>\u5c06\u4e8c\u53c9\u6bb5\u6811\u4e2d\u7684\u4f18\u5148\u7ea7\u8bbe\u7f6e\u4e3a\u6700\u5c0f\u503c</h4>\n",
 "<h4>Set priority in binary segment tree for sum</h4>\n": "<h4>\u5728\u4e8c\u53c9\u6bb5\u6811\u4e2d\u8bbe\u7f6e sum \u7684\u4f18\u5148\u7ea7</h4>\n",
 "<p><span translate=no>_^_0_^_</span> </p>\n": "<p><span translate=no>_^_0_^_</span></p>\n",
 "<p><span translate=no>_^_0_^_</span>, new samples get <span translate=no>_^_1_^_</span> </p>\n": "<p><span translate=no>_^_0_^_</span>\uff0c\u65b0\u6837\u54c1\u5f97\u5230<span translate=no>_^_1_^_</span></p>\n",
 "<p>Arrays for buffer </p>\n": "<p>\u7f13\u51b2\u533a\u6570\u7ec4</p>\n",
 "<p>Calculate <span translate=no>_^_0_^_</span> </p>\n": "<p>\u8ba1\u7b97<span translate=no>_^_0_^_</span></p>\n",
 "<p>Calculate the size </p>\n": "<p>\u8ba1\u7b97\u5927\u5c0f</p>\n",
 "<p>Current max priority, <span translate=no>_^_0_^_</span>, to be assigned to new transitions </p>\n": "<p>\u8981\u5206\u914d\u7ed9\u65b0\u8fc7\u6e21\u7684\u5f53\u524d\u6700\u5927\u4f18\u5148\u7ea7<span translate=no>_^_0_^_</span></p>\n",
 "<p>Get next available slot </p>\n": "<p>\u83b7\u53d6\u4e0b\u4e00\u4e2a\u53ef\u7528\u63d2\u69fd</p>\n",
 "<p>Get sample indexes </p>\n": "<p>\u83b7\u53d6\u6837\u672c\u7d22\u5f15</p>\n",
 "<p>Get samples data </p>\n": "<p>\u83b7\u53d6\u6837\u672c\u6570\u636e</p>\n",
 "<p>Get the index of the parent node </p>\n": "<p>\u83b7\u53d6\u7236\u8282\u70b9\u7684\u7d22\u5f15</p>\n",
 "<p>Go to left branch of the tree </p>\n": "<p>\u8f6c\u5230\u6811\u7684\u5de6\u4fa7\u5206\u652f</p>\n",
 "<p>If the sum of the left branch is higher than required sum </p>\n": "<p>\u5982\u679c\u5de6\u4fa7\u5206\u652f\u7684\u603b\u548c\u9ad8\u4e8e\u8981\u6c42\u7684\u603b\u548c</p>\n",
 "<p>Increment next available slot </p>\n": "<p>\u589e\u52a0\u4e0b\u4e00\u4e2a\u53ef\u7528\u63d2\u69fd</p>\n",
 "<p>Initialize samples </p>\n": "<p>\u521d\u59cb\u5316\u6837\u672c</p>\n",
 "<p>Leaf of the binary tree </p>\n": "<p>\u4e8c\u53c9\u6811\u7684\u53f6\u5b50</p>\n",
 "<p>Maintain segment binary trees to take sum and find minimum over a range </p>\n": "<p>\u7ef4\u62a4\u5206\u6bb5\u4e8c\u53c9\u6811\u4ee5\u6c42\u548c\u5e76\u627e\u51fa\u4e00\u5b9a\u8303\u56f4\u5185\u7684\u6700\u5c0f\u503c</p>\n",
 "<p>Normalize by <span translate=no>_^_0_^_</span>,  which also cancels off the <span translate=no>_^_1_^_</span> term </p>\n": "<p>\u6807\u51c6\u5316\u4f9d<span translate=no>_^_0_^_</span>\u636e\uff0c\u8fd9\u4e5f\u4f1a\u53d6\u6d88\u8be5<span translate=no>_^_1_^_</span>\u671f\u9650</p>\n",
 "<p>Otherwise go to right branch and reduce the sum of left  branch from required sum </p>\n": "<p>\u5426\u5219\uff0c\u8f6c\u5230\u53f3\u5206\u652f\u5e76\u4ece\u6240\u9700\u7684\u603b\u548c\u4e2d\u51cf\u5c11\u5de6\u5206\u652f\u7684\u603b\u548c</p>\n",
 "<p>Set current max priority </p>\n": "<p>\u8bbe\u7f6e\u5f53\u524d\u6700\u5927\u4f18\u5148\u7ea7</p>\n",
 "<p>Set the priority at the leaf </p>\n": "<p>\u5728\u53f6\u5b50\u4e0a\u8bbe\u7f6e\u4f18\u5148\u7ea7</p>\n",
 "<p>Size of the buffer </p>\n": "<p>\u7f13\u51b2\u533a\u7684\u5927\u5c0f</p>\n",
 "<p>Start from the root </p>\n": "<p>\u4ece\u6839\u5f00\u59cb</p>\n",
 "<p>The root node keeps the minimum of all values </p>\n": "<p>\u6839\u8282\u70b9\u4fdd\u7559\u6240\u6709\u503c\u4e2d\u7684\u6700\u5c0f\u503c</p>\n",
 "<p>The root node keeps the sum of all values </p>\n": "<p>\u6839\u8282\u70b9\u4fdd\u7559\u6240\u6709\u503c\u7684\u603b\u548c</p>\n",
 "<p>Update the trees </p>\n": "<p>\u66f4\u65b0\u6811\u6728</p>\n",
 "<p>Update the two segment trees for sum and minimum </p>\n": "<p>\u66f4\u65b0\u603b\u548c\u548c\u548c\u6700\u5c0f\u503c\u7684\u4e24\u4e2a\u533a\u6bb5\u6811</p>\n",
 "<p>Update tree, by traversing along ancestors. Continue until the root of the tree. </p>\n": "<p>\u901a\u8fc7\u6cbf\u7740\u7956\u5148\u904d\u5386\u6765\u66f4\u65b0\u6811\u3002\u7ee7\u7eed\u76f4\u5230\u6811\u7684\u6839\u90e8\u3002</p>\n",
 "<p>Value of the parent node is the minimum of it&#x27;s two children </p>\n": "<p>\u7236\u8282\u70b9\u7684\u503c\u662f\u5176\u4e24\u4e2a\u5b50\u8282\u70b9\u4e2d\u7684\u6700\u5c0f\u503c</p>\n",
 "<p>Value of the parent node is the sum of it&#x27;s two children </p>\n": "<p>\u7236\u8282\u70b9\u7684\u503c\u662f\u5176\u4e24\u4e2a\u5b50\u8282\u70b9\u7684\u603b\u548c</p>\n",
 "<p>We are at the leaf node. Subtract the capacity by the index in the tree to get the index of actual value </p>\n": "<p>\u6211\u4eec\u5728\u53f6\u8282\u70b9\u3002\u901a\u8fc7\u6811\u4e2d\u7684\u7d22\u5f15\u51cf\u53bb\u5bb9\u91cf\uff0c\u5f97\u51fa\u5b9e\u9645\u503c\u7684\u7d22\u5f15</p>\n",
 "<p>We use a power of <span translate=no>_^_0_^_</span> for capacity because it simplifies the code and debugging </p>\n": "<p>\u6211\u4eec\u4f7f\u7528 power f<span translate=no>_^_0_^_</span> or capacity\uff0c\u56e0\u4e3a\u5b83\u7b80\u5316\u4e86\u4ee3\u7801\u548c\u8c03\u8bd5</p>\n",
 "<p>We use cyclic buffers to store data, and <span translate=no>_^_0_^_</span> keeps the index of the next empty slot </p>\n": "<p>\u6211\u4eec\u4f7f\u7528\u5faa\u73af\u7f13\u51b2\u533a\u6765\u5b58\u50a8\u6570\u636e\uff0c\u5e76<span translate=no>_^_0_^_</span>\u4fdd\u7559\u4e0b\u4e00\u4e2a\u7a7a\u69fd\u7684\u7d22\u5f15</p>\n",
 "<p>store in the queue </p>\n": "<p>\u5b58\u50a8\u5728\u961f\u5217\u4e2d</p>\n",
 "Annotated implementation of prioritized experience replay using a binary segment tree.": "\u4f7f\u7528\u4e8c\u53c9\u533a\u6bb5\u6811\u7684\u5e26\u6ce8\u91ca\u5b9e\u73b0\u4f18\u5148\u7ea7\u4f53\u9a8c\u56de\u653e\u3002",
 "Prioritized Experience Replay Buffer": "\u4f18\u5148\u4f53\u9a8c\u91cd\u64ad\u7f13\u51b2\u533a"
}